{% extends "base.html" %}
{% block title %}Reporty – {{ suite.name }} · {{ project.name }}{% endblock %}

{% block content %}
<section class="hero-report full">
  <div class="card-glass wide runs-page">

    <!-- hlavička -->
    <div class="header-row">
      <div>
        <div class="eyebrow">Reporty · {{ project.name }}</div>
        <h1 class="title"><span class="accent">{{ suite.name }}</span></h1>
        {% if suite.description %}<p class="sub" style="margin-top:6px;">{{ suite.description }}</p>{% endif %}
      </div>
      <div class="cta-row" style="margin:0;">
        <a class="btn btn-ghost" href="{{ url_for('bp.public_projects_list') }}">← Zpět na projekty</a>
      </div>
    </div>

    {% if runs and runs|length %}

      <!-- toolbar s hledáním -->
      <div class="runs-toolbar">
        <input id="runs-q" type="search" placeholder="Hledat podle názvu běhu nebo souboru…" aria-label="Hledat běh">
      </div>

      <div class="table-wrap">
        <table class="table nice runs-table">
<thead>
  <tr>
    <th style="width:42%">Název běhu / soubor</th>
    <th>Souhrn</th>
    <th style="white-space:nowrap">Vytvořeno</th>
    <th class="col-actions">Akce</th>
  </tr>
</thead>
          <tbody id="runs-body">
  {% for r in runs %}
    {% set filename = r.csv_path.rsplit('/', 1)[-1] %}
    {% set t = (r.stats.total or 0) if r.stats else 0 %}
    {% set okp   = ((100.0 * r.stats.passed  / t)|round(1))  if t else 0 %}
    {% set failp = ((100.0 * r.stats.failed  / t)|round(1))  if t else 0 %}
    {% set skipp = ((100.0 * r.stats.skipped / t)|round(1))  if t else 0 %}

    <tr class="run-row" data-search="{{ (r.label or 'beh') | lower }} {{ filename | lower }}">
      <td class="cell-name">
        <div class="name ellip">{{ r.label or "Běh" }}</div>
        <div class="meta-line">
          <code class="mono ellip">{{ filename }}</code>
        </div>
      </td>

      <td class="cell-stats">
        {% if r.stats %}
          <div class="stats">
            <!-- kompaktní stacked bar; šířky z procent -->
            <div class="statsbar"
                 style="--okp: {{ okp }}; --failp: {{ failp }}; --skipp: {{ skipp }};"></div>
            <div class="statsline">
              <span class="muted">{{ r.stats.total }} testů</span>
              <span class="ok">✓ {{ r.stats.passed }}</span>
              <span class="fail">✕ {{ r.stats.failed }}</span>
              <span class="skip">∘ {{ r.stats.skipped }}</span>
              <span class="dur mono">{{ r.stats.duration_fmt }}</span>
            </div>
          </div>
        {% else %}
          <span class="text-muted">—</span>
        {% endif %}
      </td>

      <td class="cell-date mono">
        {{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '—' }}
      </td>

      <td class="actions">
        <a class="btn btn-primary btn-sm"
           href="{{ url_for('bp.report_view', file=r.csv_path) }}">Zobrazit</a>
        <a class="btn btn-ghost btn-sm"
           href="{{ url_for('bp.storage_reports', filename=r.csv_path) }}"
           target="_blank" rel="noopener">CSV</a>
      </td>
    </tr>
  {% endfor %}
</tbody>

        </table>
      </div>
    {% else %}
      <div class="empty"><p class="sub">Zatím tu nejsou žádné reporty.</p></div>
    {% endif %}
  </div>
</section>

<!-- rychlé vyhledávání v bězích -->
<script>
(function(){
  const q = document.getElementById('runs-q');
  const rows = Array.from(document.querySelectorAll('#runs-body .run-row'));
  if(!q) return;
  const apply = () => {
    const needle = q.value.trim().toLowerCase();
    rows.forEach(tr => {
      const hay = tr.dataset.search || '';
      tr.style.display = (!needle || hay.includes(needle)) ? '' : 'none';
    });
  };
  q.addEventListener('input', apply);
})();
</script>
{% endblock %}
