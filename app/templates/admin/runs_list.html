{% extends "base.html" %}
{% block title %}Běhy – {{ project.name }} / {{ suite.name }}{% endblock %}

{% block content %}
<section class="section-hero hero-aurora">
  <div class="hero-grid"></div>
    <div class="card-glass wide">

    <div class="header-row" style="align-items:center;">
      <div>
        <div class="eyebrow">Admin</div>
        <h1 class="title">Běhy – <span class="accent">{{ project.name }}</span> / {{ suite.name }}</h1>
        <p class="sub" style="margin-top:6px;">Nahrávej CSV a hned vidíš v seznamu.</p>
      </div>
      <div class="cta-row" style="margin:0;">
        <a class="btn btn-ghost" href="{{ url_for('admin.suites', project_id=project.id) }}">← Zpět na sekce</a>
      </div>
    </div>
    <!-- Rychlé nahrání -->
    <form class="form" method="post" enctype="multipart/form-data"
          action="{{ url_for('admin.runs_upload', project_id=project.id, suite_id=suite.id) }}"
          style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="file" name="csv" accept=".csv" required class="input" style="max-width:420px;">
      <input type="text" name="label" placeholder="Krátký název (volitelné)" class="input" style="max-width:320px;">
      <button class="btn btn-primary" type="submit">Nahrát CSV</button>
    </form>

    {% if runs and runs|length %}
<div class="table-wrap">
  <table class="table nice runs-table compact">
    <thead>
      <tr>
        <th>Soubor / běh</th>
        <th>Souhrn</th>
        <th>Vytvořeno</th>
        <th class="col-actions">Akce</th>
      </tr>
    </thead>
    <tbody id="runs-body">
      {% for r in runs %}
        {% set filename = r.csv_path.rsplit('/', 1)[-1] %}
        {% set t = (r.stats.total or 0) if r.stats else 0 %}
        {% set okp   = ((100.0 * r.stats.passed  / t)|round(1))  if t else 0 %}
        {% set failp = ((100.0 * r.stats.failed  / t)|round(1))  if t else 0 %}
        {% set skipp = ((100.0 * r.stats.skipped / t)|round(1))  if t else 0 %}

        <tr class="run-row"
            data-search="{{ (r.label or 'beh') | lower }} {{ filename | lower }}">
          <td class="cell-name">
            <div class="file ellip">{{ filename }}</div>
            <div class="meta-line ellip">
              <span class="muted">Běh:</span> {{ r.label or "Běh" }}
            </div>
          </td>

          <td class="cell-stats">
            {% if r.stats %}
              <div class="stats">
                <div class="statsbar"
                     style="--okp: {{ okp }}; --failp: {{ failp }}; --skipp: {{ skipp }};"></div>
                <div class="statsline">
                  <span class="muted">{{ r.stats.total }} testů</span>
                  <span class="ok">✓ {{ r.stats.passed }}</span>
                  <span class="fail">✕ {{ r.stats.failed }}</span>
                  <span class="skip">∘ {{ r.stats.skipped }}</span>
                  <span class="dur mono">{{ r.stats.duration_fmt }}</span>
                </div>
              </div>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>

          <td class="cell-date mono">
            {{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '—' }}
          </td>

          <td class="actions">
            <a class="btn btn-primary btn-sm"
               href="{{ url_for('bp.report_view', file=r.csv_path) }}">Zobrazit</a>
            <a class="btn btn-ghost btn-sm"
               href="{{ url_for('bp.storage_reports', filename=r.csv_path) }}"
               target="_blank" rel="noopener">CSV</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

    {% else %}
      <div class="empty"><p class="sub">Zatím žádné běhy.</p></div>
    {% endif %}
  </div>
</section>
{% endblock %}
